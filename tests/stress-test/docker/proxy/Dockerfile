FROM telegraf:latest AS build

FROM eclipse-temurin:11

COPY --from=build //usr/bin/telegraf /bin/telegraf
ADD telegraf.conf /etc/telegraf/telegraf.conf
ADD wait-for-it.sh /opt/others/
ADD certs /tmp/ca/
ADD proxy.cfg /etc/


RUN apt-get -qq -o=Dpkg::Use-Pty=0 update && \
    apt-get -qq -o=Dpkg::Use-Pty=0 install -y libaio1

# This script may automatically configure wavefront without prompting, based on
# these variables:
#  WAVEFRONT_URL           (required)
#  WAVEFRONT_TOKEN         (required)
#  JAVA_HEAP_USAGE         (default is 4G)
#  WAVEFRONT_HOSTNAME      (default is the docker containers hostname)
#  WAVEFRONT_PROXY_ARGS    (default is none)
#  JAVA_ARGS               (default is none)

# Add new group:user "wavefront"
RUN groupadd -g 2000 wavefront
RUN useradd --uid 1000 --gid 2000 -m wavefront
RUN chown -R wavefront:wavefront /opt/java/openjdk/lib/security/cacerts
RUN mkdir -p /var/spool/wavefront-proxy/buffer
RUN chown -R wavefront:wavefront /var/spool/wavefront-proxy
RUN mkdir -p /var/log/wavefront
RUN chown -R wavefront:wavefront /var/log/wavefront

# Run the agent
EXPOSE 2878

USER wavefront:wavefront

COPY wavefront-proxy.jar /opt/wavefront/wavefront-proxy/wavefront-proxy.jar
COPY run.sh /opt/wavefront/wavefront-proxy/run.sh
COPY log4j2.xml /etc/wavefront/wavefront-proxy/log4j2.xml

CMD ["/bin/bash", "/opt/wavefront/wavefront-proxy/run.sh"]
